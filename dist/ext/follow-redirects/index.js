import t from"url";import e from"http";import r from"https";import o from"stream";import s from"assert";import i from"./debug.js";var n=t.URL,h=o.Writable,a=["abort","aborted","connect","error","socket","timeout"],u=Object.create(null);a.forEach((function(t){u[t]=function(e,r,o){this._redirectable.emit(t,e,r,o)}}));var c=v("ERR_FR_REDIRECTION_FAILURE","Redirected request failed"),p=v("ERR_FR_TOO_MANY_REDIRECTS","Maximum number of redirects exceeded"),d=v("ERR_FR_MAX_BODY_LENGTH_EXCEEDED","Request body larger than maxBodyLength limit"),f=v("ERR_STREAM_WRITE_AFTER_END","write after end");function _(t,e){h.call(this),this._sanitizeOptions(t),this._options=t,this._ended=!1,this._ending=!1,this._redirectCount=0,this._redirects=[],this._requestBodyLength=0,this._requestBodyBuffers=[],e&&this.on("response",e);var r=this;this._onNativeResponse=function(t){r._processResponse(t)},this._performRequest()}function m(e){var r={maxRedirects:21,maxBodyLength:10485760},o={};return Object.keys(e).forEach((function(h){var a=h+":",u=o[a]=e[h],c=r[h]=Object.create(u);Object.defineProperties(c,{request:{value:function(e,h,u){if("string"==typeof e){var c=e;try{e=y(new n(c))}catch(r){e=t.parse(c)}}else n&&e instanceof n?e=y(e):(u=h,h=e,e={protocol:a});return"function"==typeof h&&(u=h,h=null),(h=Object.assign({maxRedirects:r.maxRedirects,maxBodyLength:r.maxBodyLength},e,h)).nativeProtocols=o,s.equal(h.protocol,a,"protocol mismatch"),i("options",h),new _(h,u)},configurable:!0,enumerable:!0,writable:!0},get:{value:function(t,e,r){var o=c.request(t,e,r);return o.end(),o},configurable:!0,enumerable:!0,writable:!0}})})),r}function l(){}function y(t){var e={protocol:t.protocol,hostname:t.hostname.startsWith("[")?t.hostname.slice(1,-1):t.hostname,hash:t.hash,search:t.search,pathname:t.pathname,path:t.pathname+t.search,href:t.href};return""!==t.port&&(e.port=Number(t.port)),e}function R(t,e){var r;for(var o in e)t.test(o)&&(r=e[o],delete e[o]);return null==r?void 0:String(r).trim()}function v(t,e){function r(t){Error.captureStackTrace(this,this.constructor),t?(this.message=e+": "+t.message,this.cause=t):this.message=e}return r.prototype=new Error,r.prototype.constructor=r,r.prototype.name="Error ["+t+"]",r.prototype.code=t,r}function g(t){for(var e of a)t.removeListener(e,u[e]);t.on("error",l),t.abort()}_.prototype=Object.create(h.prototype),_.prototype.abort=function(){g(this._currentRequest),this.emit("abort")},_.prototype.write=function(t,e,r){if(this._ending)throw new f;if(!("string"==typeof t||"object"==typeof t&&"length"in t))throw new TypeError("data should be a string, Buffer or Uint8Array");"function"==typeof e&&(r=e,e=null),0!==t.length?this._requestBodyLength+t.length<=this._options.maxBodyLength?(this._requestBodyLength+=t.length,this._requestBodyBuffers.push({data:t,encoding:e}),this._currentRequest.write(t,e,r)):(this.emit("error",new d),this.abort()):r&&r()},_.prototype.end=function(t,e,r){if("function"==typeof t?(r=t,t=e=null):"function"==typeof e&&(r=e,e=null),t){var o=this,s=this._currentRequest;this.write(t,e,(function(){o._ended=!0,s.end(null,null,r)})),this._ending=!0}else this._ended=this._ending=!0,this._currentRequest.end(null,null,r)},_.prototype.setHeader=function(t,e){this._options.headers[t]=e,this._currentRequest.setHeader(t,e)},_.prototype.removeHeader=function(t){delete this._options.headers[t],this._currentRequest.removeHeader(t)},_.prototype.setTimeout=function(t,e){var r=this;function o(e){e.setTimeout(t),e.removeListener("timeout",e.destroy),e.addListener("timeout",e.destroy)}function s(e){r._timeout&&clearTimeout(r._timeout),r._timeout=setTimeout((function(){r.emit("timeout"),i()}),t),o(e)}function i(){r._timeout&&(clearTimeout(r._timeout),r._timeout=null),r.removeListener("abort",i),r.removeListener("error",i),r.removeListener("response",i),e&&r.removeListener("timeout",e),r.socket||r._currentRequest.removeListener("socket",s)}return e&&this.on("timeout",e),this.socket?s(this.socket):this._currentRequest.once("socket",s),this.on("socket",o),this.on("abort",i),this.on("error",i),this.on("response",i),this},["flushHeaders","getHeader","setNoDelay","setSocketKeepAlive"].forEach((function(t){_.prototype[t]=function(e,r){return this._currentRequest[t](e,r)}})),["aborted","connection","socket"].forEach((function(t){Object.defineProperty(_.prototype,t,{get:function(){return this._currentRequest[t]}})})),_.prototype._sanitizeOptions=function(t){if(t.headers||(t.headers={}),t.host&&(t.hostname||(t.hostname=t.host),delete t.host),!t.pathname&&t.path){var e=t.path.indexOf("?");e<0?t.pathname=t.path:(t.pathname=t.path.substring(0,e),t.search=t.path.substring(e))}},_.prototype._performRequest=function(){var e=this._options.protocol,r=this._options.nativeProtocols[e];if(r){if(this._options.agents){var o=e.slice(0,-1);this._options.agent=this._options.agents[o]}var s=this._currentRequest=r.request(this._options,this._onNativeResponse);for(var i of(s._redirectable=this,a))s.on(i,u[i]);if(this._currentUrl=/^\//.test(this._options.path)?t.format(this._options):this._currentUrl=this._options.path,this._isRedirect){var n=0,h=this,c=this._requestBodyBuffers;!function t(e){if(s===h._currentRequest)if(e)h.emit("error",e);else if(n<c.length){var r=c[n++];s.finished||s.write(r.data,r.encoding,t)}else h._ended&&s.end()}()}}else this.emit("error",new TypeError("Unsupported protocol "+e))},_.prototype._processResponse=function(e){var r=e.statusCode;this._options.trackRedirects&&this._redirects.push({url:this._currentUrl,headers:e.headers,statusCode:r});var o=e.headers.location;if(!o||!1===this._options.followRedirects||r<300||r>=400)return e.responseUrl=this._currentUrl,e.redirects=this._redirects,this.emit("response",e),void(this._requestBodyBuffers=[]);if(g(this._currentRequest),e.destroy(),++this._redirectCount>this._options.maxRedirects)this.emit("error",new p);else{var s,n=this._options.beforeRedirect;n&&(s=Object.assign({Host:e.req.getHeader("host")},this._options.headers));var h=this._options.method;((301===r||302===r)&&"POST"===this._options.method||303===r&&!/^(?:GET|HEAD)$/.test(this._options.method))&&(this._options.method="GET",this._requestBodyBuffers=[],R(/^content-/i,this._options.headers));var a,u=R(/^host$/i,this._options.headers),d=t.parse(this._currentUrl),f=u||d.host,_=/^\w+:/.test(o)?this._currentUrl:t.format(Object.assign(d,{host:f}));try{a=t.resolve(_,o)}catch(t){return void this.emit("error",new c(t))}i("redirecting to",a),this._isRedirect=!0;var m=t.parse(a);if(Object.assign(this._options,m),(m.protocol!==d.protocol&&"https:"!==m.protocol||m.host!==f&&!function(t,e){const r=t.length-e.length-1;return r>0&&"."===t[r]&&t.endsWith(e)}(m.host,f))&&R(/^(?:authorization|cookie)$/i,this._options.headers),"function"==typeof n){var l={headers:e.headers,statusCode:r},y={url:_,method:h,headers:s};try{n(this._options,l,y)}catch(t){return void this.emit("error",t)}this._sanitizeOptions(this._options)}try{this._performRequest()}catch(t){this.emit("error",new c(t))}}};var b=m({http:e,https:r}),q=m;b.wrap=q;export{b as default,q as wrap};
