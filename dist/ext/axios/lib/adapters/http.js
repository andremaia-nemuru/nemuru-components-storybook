import e from"../utils.js";import t from"../core/settle.js";import r from"../core/buildFullPath.js";import o from"../helpers/buildURL.js";import a from"http";import n from"https";import s from"../../../follow-redirects/index.js";import i from"url";import u from"zlib";import c from"../env/data.js";import p from"../core/createError.js";import f from"../core/enhanceError.js";import h from"../defaults/transitional.js";import m from"../cancel/Cancel.js";var d=s.http,l=s.https,g=c.version,v=/https:?/;function E(e,t,r){if(e.hostname=t.host,e.host=t.host,e.port=t.port,e.path=r,t.auth){var o=Buffer.from(t.auth.username+":"+t.auth.password,"utf8").toString("base64");e.headers["Proxy-Authorization"]="Basic "+o}e.beforeRedirect=function(e){e.headers.host=e.host,E(e,t,e.href)}}var b=function(s){return new Promise((function(c,b){var x;function y(){s.cancelToken&&s.cancelToken.unsubscribe(x),s.signal&&s.signal.removeEventListener("abort",x)}var T=function(e){y(),c(e)},R=!1,B=function(e){y(),R=!0,b(e)},L=s.data,A=s.headers,P={};if(Object.keys(A).forEach((function(e){P[e.toLowerCase()]=e})),"user-agent"in P?A[P["user-agent"]]||delete A[P["user-agent"]]:A["User-Agent"]="axios/"+g,L&&!e.isStream(L)){if(Buffer.isBuffer(L));else if(e.isArrayBuffer(L))L=Buffer.from(new Uint8Array(L));else{if(!e.isString(L))return B(p("Data after transformation must be a string, an ArrayBuffer, a Buffer, or a Stream",s));L=Buffer.from(L,"utf-8")}if(s.maxBodyLength>-1&&L.length>s.maxBodyLength)return B(p("Request body larger than maxBodyLength limit",s));P["content-length"]||(A["Content-Length"]=L.length)}var C=void 0;s.auth&&(C=(s.auth.username||"")+":"+(s.auth.password||""));var j=r(s.baseURL,s.url),O=i.parse(j),S=O.protocol||"http:";if(!C&&O.auth){var _=O.auth.split(":");C=(_[0]||"")+":"+(_[1]||"")}C&&P.authorization&&delete A[P.authorization];var k=v.test(S),w=k?s.httpsAgent:s.httpAgent;try{o(O.path,s.params,s.paramsSerializer).replace(/^\?/,"")}catch(e){var U=new Error(e.message);U.config=s,U.url=s.url,U.exists=!0,B(U)}var z={path:o(O.path,s.params,s.paramsSerializer).replace(/^\?/,""),method:s.method.toUpperCase(),headers:A,agent:w,agents:{http:s.httpAgent,https:s.httpsAgent},auth:C};s.socketPath?z.socketPath=s.socketPath:(z.hostname=O.hostname,z.port=O.port);var M,q=s.proxy;if(!q&&!1!==q){var D=S.slice(0,-1)+"_proxy",N=process.env[D]||process.env[D.toUpperCase()];if(N){var H=i.parse(N),I=process.env.no_proxy||process.env.NO_PROXY,F=!0;if(I)F=!I.split(",").map((function(e){return e.trim()})).some((function(e){return!!e&&("*"===e||("."===e[0]&&O.hostname.substr(O.hostname.length-e.length)===e||O.hostname===e))}));if(F&&(q={host:H.hostname,port:H.port,protocol:H.protocol},H.auth)){var Y=H.auth.split(":");q.auth={username:Y[0],password:Y[1]}}}}q&&(z.headers.host=O.hostname+(O.port?":"+O.port:""),E(z,q,S+"//"+O.hostname+(O.port?":"+O.port:"")+z.path));var K=k&&(!q||v.test(q.protocol));s.transport?M=s.transport:0===s.maxRedirects?M=K?n:a:(s.maxRedirects&&(z.maxRedirects=s.maxRedirects),M=K?l:d),s.maxBodyLength>-1&&(z.maxBodyLength=s.maxBodyLength),s.insecureHTTPParser&&(z.insecureHTTPParser=s.insecureHTTPParser);var Q=M.request(z,(function(r){if(!Q.aborted){var o=r,a=r.req||Q;if(204!==r.statusCode&&"HEAD"!==a.method&&!1!==s.decompress)switch(r.headers["content-encoding"]){case"gzip":case"compress":case"deflate":o=o.pipe(u.createUnzip()),delete r.headers["content-encoding"]}var n={status:r.statusCode,statusText:r.statusMessage,headers:r.headers,config:s,request:a};if("stream"===s.responseType)n.data=o,t(T,B,n);else{var i=[],c=0;o.on("data",(function(e){i.push(e),c+=e.length,s.maxContentLength>-1&&c>s.maxContentLength&&(R=!0,o.destroy(),B(p("maxContentLength size of "+s.maxContentLength+" exceeded",s,null,a)))})),o.on("aborted",(function(){R||(o.destroy(),B(p("error request aborted",s,"ERR_REQUEST_ABORTED",a)))})),o.on("error",(function(e){Q.aborted||B(f(e,s,null,a))})),o.on("end",(function(){try{var r=1===i.length?i[0]:Buffer.concat(i);"arraybuffer"!==s.responseType&&(r=r.toString(s.responseEncoding),s.responseEncoding&&"utf8"!==s.responseEncoding||(r=e.stripBOM(r))),n.data=r}catch(e){B(f(e,s,e.code,n.request,n))}t(T,B,n)}))}}}));if(Q.on("error",(function(e){Q.aborted&&"ERR_FR_TOO_MANY_REDIRECTS"!==e.code||B(f(e,s,null,Q))})),Q.on("socket",(function(e){e.setKeepAlive(!0,6e4)})),s.timeout){var X=parseInt(s.timeout,10);if(isNaN(X))return void B(p("error trying to parse `config.timeout` to int",s,"ERR_PARSE_TIMEOUT",Q));Q.setTimeout(X,(function(){Q.abort();var e="";e=s.timeoutErrorMessage?s.timeoutErrorMessage:"timeout of "+s.timeout+"ms exceeded";var t=s.transitional||h;B(p(e,s,t.clarifyTimeoutError?"ETIMEDOUT":"ECONNABORTED",Q))}))}(s.cancelToken||s.signal)&&(x=function(e){Q.aborted||(Q.abort(),B(!e||e&&e.type?new m("canceled"):e))},s.cancelToken&&s.cancelToken.subscribe(x),s.signal&&(s.signal.aborted?x():s.signal.addEventListener("abort",x))),e.isStream(L)?L.on("error",(function(e){B(f(e,s,null,Q))})).pipe(Q):Q.end(L)}))};export{b as default};
